<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Eggs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .game-container {
            background: #2c2c2c;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 100%;
            text-align: center;
            position: relative;
            border: 2px solid #444;
        }

        .player-id {
            position: absolute;
            top: 15px;
            left: 15px;
            background: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
        }

        .header {
            margin-bottom: 25px;
            margin-top: 10px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #fff;
        }

        .egg-display {
            margin: 25px 0;
            position: relative;
        }

        .egg {
            font-size: 100px;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }

        .egg-type {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #2c3e50;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }

        .timer {
            background: #e74c3c;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 16px;
        }

        .hatch-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            font-size: 16px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4a4a4a, #666);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            position: relative;
            border: 1px solid #555;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
        }

        .food-count {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .btn-admin {
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            color: #2c3e50;
            font-weight: bold;
            margin: 15px 0;
            width: 100%;
            padding: 15px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .menu-section {
            margin-top: 25px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .info-text {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 14px;
            color: #ccc;
            line-height: 1.4;
            border: 1px solid #555;
        }

        .admin-panel {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            color: white;
            display: none;
            border: 2px solid #444;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .admin-input {
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #555;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            margin-top: 10px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #27ae60;
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .admin-header {
            text-align: center;
            margin-bottom: 20px;
            color: #ffd700;
            font-size: 1.3em;
        }

        .shop-modal, .confirm-modal, .inventory-modal, .withdraw-modal, .quests-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .shop-modal.active, .confirm-modal.active, .inventory-modal.active, .withdraw-modal.active, .quests-modal.active {
            display: flex;
        }

        .shop-content, .confirm-content, .inventory-content, .withdraw-content, .quests-content {
            background: #2c2c2c;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            border: 2px solid #444;
            color: white;
        }

        .shop-item {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
        }

        .inventory-item {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #555;
        }

        .quest-item {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #555;
        }

        .quest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .quest-progress {
            background: #555;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .quest-progress-bar {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            height: 100%;
            transition: width 0.3s ease;
        }

        .quest-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
            font-size: 14px;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .dead-egg {
            filter: grayscale(1);
            opacity: 0.7;
        }

        .death-message {
            color: #e74c3c;
            font-weight: bold;
            margin: 10px 0;
        }

        .empty-inventory {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .withdraw-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .quest-btn {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .quest-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .withdraw-log {
            background: #3a3a3a;
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
            border: 1px solid #555;
            font-size: 12px;
        }

        .balance-info {
            background: #ffd700;
            color: #2c3e50;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
        }

        .referral-section {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
        }

        .referral-link {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            cursor: pointer;
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 14px;
        }

        .stat-number {
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="player-id">ID: <span id="playerId">Загрузка...</span></div>
        
        <div class="header">
            <h1>🥚 NFT Eggs</h1>
            <div class="egg-display">
                <div class="egg" id="eggDisplay">🐣</div>
                <div class="egg-type" id="eggTypeDisplay">Обычное яйцо</div>
                <div class="timer" id="eggTimer" style="display: none;">До вылупления: <span id="timerValue">17:00:00</span></div>
                <button class="hatch-btn" id="hatchBtn" style="display: none;">🎁 Разбить яйцо!</button>
                <div id="deathMessage" class="death-message" style="display: none;">Яйцо умерло! Купите новое</div>
            </div>
        </div>
        
        <div class="food-count" id="foodCount">Еды: 3</div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div>Сытость</div>
                <div class="stat-value" id="hungerValue">25/100</div>
            </div>
            <div class="stat-card">
                <div>Настроение</div>
                <div class="stat-value" id="moodValue">97/100</div>
            </div>
            <div class="stat-card">
                <div>Звёзды</div>
                <div class="stat-value" id="starsValue">0</div>
            </div>
            <div class="stat-card">
                <div>Предметы</div>
                <div class="stat-value" id="itemsValue">0</div>
            </div>
        </div>
        
        <div class="actions-grid">
            <button class="btn btn-primary" id="feedBtn">🍎 Покормить</button>
            <button class="btn btn-secondary" id="playBtn">🎮 Поиграть</button>
        </div>

        <!-- Реферальная секция -->
        <div class="referral-section">
            <h3>👥 Пригласи друзей!</h3>
            <p>Отправь эту ссылку друзьям:</p>
            <div class="referral-link" id="referralLink">Загрузка...</div>
            <div class="referral-stats">
                <div>
                    <div class="stat-number" id="referralCount">0</div>
                    <div>Приглашено</div>
                </div>
                <div>
                    <div class="stat-number" id="referralRewards">0</div>
                    <div>Получено еды</div>
                </div>
            </div>
        </div>

        <!-- Админ панель -->
        <button class="btn btn-admin" id="adminToggle" style="display: none;">🔧 Админ Панель</button>
        
        <div class="menu-section">
            <button class="menu-btn" id="shopBtn">🛒 Магазин</button>
            <button class="menu-btn" id="inventoryBtn">🎒 Инвентарь</button>
            <button class="menu-btn" id="questsBtn">🎯 Задания</button>
        </div>

        <div class="balance-info">
            💎 Чтобы пополнить баланс, подарите подарок на аккаунт @NFT_c0llecti0n
        </div>

        <div class="info-text">
            <strong>[🔍] Для покупок нужны Telegram Stars</strong><br>
            Получайте звёзды от друзей или покупайте в Telegram
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="admin-controls">
                <div class="admin-header">🔧 Админ Панель</div>
                
                <input type="text" class="admin-input" placeholder="ID игрока" id="adminPlayerId">
                <input type="number" class="admin-input" placeholder="Количество звёзд" id="adminStars">
                
                <button class="btn btn-admin" id="adminApply">✅ Выдать звёзды</button>
                <button class="btn btn-danger" id="adminReset">🔄 Сбросить прогресс</button>
                
                <div class="admin-header" style="margin-top: 20px;">📊 Заявки на вывод</div>
                <div id="withdrawRequests"></div>

                <div class="admin-header" style="margin-top: 20px;">📋 Проверка заданий</div>
                <input type="text" class="admin-input" placeholder="ID игрока" id="verifyPlayerId">
                <select class="admin-input" id="verifyQuestType">
                    <option value="subscribe">Подписка на канал</option>
                    <option value="invite">Приглашение друзей</option>
                </select>
                <button class="btn btn-admin" id="verifyQuest">✅ Подтвердить задание</button>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="shop-modal" id="shopModal">
        <div class="shop-content">
            <button class="close-btn" id="closeShop">×</button>
            <h2>🛒 Магазин</h2>
            
            <div class="shop-item">
                <div>
                    <strong>🥚 Золотое яйцо</strong><br>
                    <small>Шансы: Вино 50%, Календарь 25%, Шапка Санты 5%, Конфеты 2%</small>
                </div>
                <button class="btn btn-primary" style="padding: 8px 15px;" onclick="buyItem('gold_egg', 100)">100 ⭐</button>
            </div>
            
            <div class="shop-item">
                <div>
                    <strong>🍎 Еда (3 шт)</strong><br>
                    <small>Пополните запас еды для кормления</small>
                </div>
                <button class="btn btn-primary" style="padding: 8px 15px;" onclick="buyItem('food', 20)">20 ⭐</button>
            </div>
            
            <div class="shop-item">
                <div>
                    <strong>🥚 Обычное яйцо</strong><br>
                    <small>Шансы: Сердечко 40%, Роза 25%, Календарь 5%</small>
                </div>
                <button class="btn btn-primary" style="padding: 8px 15px;" onclick="buyItem('normal_egg', 50)">50 ⭐</button>
            </div>
        </div>
    </div>

    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3>Подтверждение покупки</h3>
            <p id="confirmText">Вы уверены, что хотите купить этот предмет?</p>
            <div class="confirm-buttons">
                <button class="btn btn-secondary" onclick="closeConfirm()">Отмена</button>
                <button class="btn btn-primary" onclick="confirmPurchase()">Купить</button>
            </div>
        </div>
    </div>

    <div class="inventory-modal" id="inventoryModal">
        <div class="inventory-content">
            <button class="close-btn" onclick="closeInventory()">×</button>
            <h2>🎒 Инвентарь</h2>
            <div id="inventoryItems"></div>
        </div>
    </div>

    <div class="withdraw-modal" id="withdrawModal">
        <div class="withdraw-content">
            <button class="close-btn" onclick="closeWithdraw()">×</button>
            <h2>📤 Заявка на вывод</h2>
            <div class="info-text">
                <p>Вы хотите вывести предмет: <strong id="withdrawItemName"></strong></p>
                <p>Напишите ваш Telegram username для связи:</p>
                <input type="text" class="admin-input" id="telegramUsername" placeholder="@username">
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="submitWithdraw()">✅ Отправить заявку</button>
            </div>
        </div>
    </div>

    <div class="quests-modal" id="questsModal">
        <div class="quests-content">
            <button class="close-btn" onclick="closeQuests()">×</button>
            <h2>🎯 Задания</h2>
            <div id="questsList"></div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // АДМИН ДОСТУП - только для моего ID
        const ADMIN_USER_ID = "USER_1761399526979_swpx4n20o";
        const BOT_USERNAME = "NFT_c0llecti0n_bot"; // Замените на username вашего бота
        let isAdmin = false;

        // Данные игрока
        let playerData = {
            id: '',
            hunger: 25,
            mood: 97,
            stars: 0,
            items: [],
            eggType: 'normal',
            foodCount: 3,
            isAlive: true,
            eggHatchTime: null,
            isEggReady: false,
            hasFedToday: false,
            quests: {
                subscribe: { completed: false, claimed: false },
                invite: { progress: 0, target: 5, claimed: false }
            },
            referralCode: '',
            referredBy: '',
            referralCount: 0,
            referralRewards: 0
        };

        // Заявки на вывод
        let withdrawRequests = [];

        // Система заданий
        const questsData = {
            subscribe: {
                title: "📢 Подписка на канал",
                description: "Подпишитесь на наш Telegram канал",
                reward: { type: "food", amount: 1 },
                action: "subscribe"
            },
            invite: {
                title: "👥 Пригласить друзей",
                description: "Пригласите 5 друзей в игру через бота",
                reward: { type: "food", amount: 3 },
                action: "invite"
            }
        };

        // Инициализация игры
        function initGame() {
            loadPlayerData();
            
            // Проверяем реферальную ссылку при загрузке
            checkReferral();
            
            // Проверяем админский доступ
            if (playerData.id === ADMIN_USER_ID) {
                isAdmin = true;
                document.getElementById('adminToggle').style.display = 'block';
                showNotification('Добро пожаловать, Админ!');
            }
            
            updateUI();
            startHatchTimer();
            startStatDecrease();
            updateWithdrawRequests();
            updateReferralLink();
        }

        // Проверка реферальной ссылки
        function checkReferral() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            
            if (refCode && !playerData.referredBy) {
                // Находим игрока, который пригласил
                const allPlayerKeys = Object.keys(localStorage).filter(key => key.startsWith('playerData_'));
                
                for (let key of allPlayerKeys) {
                    try {
                        const player = JSON.parse(localStorage.getItem(key));
                        if (player.referralCode === refCode && player.id !== playerData.id) {
                            // Обновляем статистику пригласившего
                            player.referralCount += 1;
                            localStorage.setItem('playerData_' + player.id, JSON.stringify(player));
                            
                            // Сохраняем кто пригласил текущего игрока
                            playerData.referredBy = player.id;
                            savePlayerData();
                            
                            showNotification('🎉 Вы зашли по реферальной ссылке!');
                            break;
                        }
                    } catch (e) {
                        console.error('Error processing referral:', e);
                    }
                }
            }
        }

        // Генерация уникального ID игрока
        function generatePlayerId() {
            if (!localStorage.getItem('playerId')) {
                const id = 'USER_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('playerId', id);
                
                // Генерируем реферальный код
                playerData.referralCode = 'REF_' + Math.random().toString(36).substr(2, 8).toUpperCase();
            }
            return localStorage.getItem('playerId');
        }

        // Загрузка данных
        function loadPlayerData() {
            // Загружаем ID игрока
            playerData.id = generatePlayerId();
            document.getElementById('playerId').textContent = playerData.id;
            
            // Загружаем данные игрока
            const saved = localStorage.getItem('playerData_' + playerData.id);
            if (saved) {
                const data = JSON.parse(saved);
                playerData = { ...playerData, ...data };
                
                // Убираем лимит на еду - всегда даем 3 еды при заходе
                playerData.foodCount = 3;
            }
            
            // Загружаем заявки на вывод
            const savedRequests = localStorage.getItem('withdrawRequests');
            if (savedRequests) {
                withdrawRequests = JSON.parse(savedRequests);
            }
        }

        // Сохранение данных
        function savePlayerData() {
            localStorage.setItem('playerData_' + playerData.id, JSON.stringify(playerData));
            localStorage.setItem('withdrawRequests', JSON.stringify(withdrawRequests));
        }

        // Обновление реферальной ссылки
        function updateReferralLink() {
            const referralLink = document.getElementById('referralLink');
            // Ссылка на бота с реферальным параметром
            const botUrl = `https://t.me/${BOT_USERNAME}?start=${playerData.referralCode}`;
            referralLink.textContent = botUrl;
            
            // Обновляем статистику
            document.getElementById('referralCount').textContent = playerData.referralCount;
            document.getElementById('referralRewards').textContent = playerData.referralRewards;
            
            // Добавляем возможность копирования
            referralLink.onclick = function() {
                navigator.clipboard.writeText(botUrl).then(() => {
                    showNotification('🔗 Ссылка скопирована в буфер обмена!');
                });
            };
        }

        // Система заданий
        function openQuests() {
            const questsList = document.getElementById('questsList');
            let html = '';

            // Задание на подписку
            const subscribeQuest = playerData.quests.subscribe;
            const subscribeData = questsData.subscribe;
            
            html += `
                <div class="quest-item">
                    <div class="quest-header">
                        <strong>${subscribeData.title}</strong>
                        ${subscribeQuest.claimed ? 
                            '<span style="color: #27ae60;">✅ Выполнено</span>' : 
                            (subscribeQuest.completed ? 
                                '<button class="quest-btn" onclick="claimQuestReward(\'subscribe\')">🎁 Получить награду</button>' :
                                '<button class="quest-btn" onclick="openSubscribeLink()">🔗 Перейти в канал</button>'
                            )
                        }
                    </div>
                    <p>${subscribeData.description}</p>
                    <div class="quest-reward">
                        🎁 Награда: ${subscribeData.reward.amount} 🍎 Еда
                    </div>
                </div>
            `;

            // Задание на приглашения
            const inviteQuest = playerData.quests.invite;
            const inviteData = questsData.invite;
            const progressPercent = (inviteQuest.progress / inviteQuest.target) * 100;
            
            html += `
                <div class="quest-item">
                    <div class="quest-header">
                        <strong>${inviteData.title}</strong>
                        ${inviteQuest.claimed ? 
                            '<span style="color: #27ae60;">✅ Выполнено</span>' : 
                            (inviteQuest.progress >= inviteQuest.target ? 
                                '<button class="quest-btn" onclick="claimQuestReward(\'invite\')">🎁 Получить награду</button>' :
                                `<span>${inviteQuest.progress}/${inviteQuest.target}</span>`
                            )
                        }
                    </div>
                    <p>${inviteData.description}</p>
                    <div class="quest-progress">
                        <div class="quest-progress-bar" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="quest-reward">
                        🎁 Награда: ${inviteData.reward.amount} 🍎 Еда
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; background: #444; padding: 8px; border-radius: 5px;">
                        <strong>Статистика приглашений:</strong><br>
                        Приглашено друзей: <strong>${playerData.referralCount}</strong><br>
                        Получено наград: <strong>${playerData.referralRewards}</strong>
                    </div>
                </div>
            `;

            questsList.innerHTML = html;
            document.getElementById('questsModal').classList.add('active');
        }

        function closeQuests() {
            document.getElementById('questsModal').classList.remove('active');
        }

        function openSubscribeLink() {
            // Ссылка на ваш канал
            window.open('https://t.me/MyNFTPet', '_blank');
            showNotification('После подписки нажмите "Проверить подписку" в заданиях');
        }

        function claimQuestReward(questType) {
            const quest = playerData.quests[questType];
            const questInfo = questsData[questType];
            
            if (quest.claimed) {
                showNotification('Вы уже получили награду за это задание!');
                return;
            }

            if (questType === 'subscribe' && !quest.completed) {
                showNotification('Сначала выполните задание!');
                return;
            }

            if (questType === 'invite' && quest.progress < quest.target) {
                showNotification('Сначала выполните задание!');
                return;
            }

            // Выдаем награду
            if (questInfo.reward.type === 'food') {
                playerData.foodCount += questInfo.reward.amount;
                showNotification(`🎉 Получено ${questInfo.reward.amount} еды!`);
                
                // Для задания на приглашения обновляем статистику наград
                if (questType === 'invite') {
                    playerData.referralRewards += 1;
                }
            }

            quest.claimed = true;
            savePlayerData();
            updateUI();
            updateReferralLink();
            closeQuests();
        }

        // Админ: проверка выполнения заданий
        function verifyQuestCompletion() {
            if (!isAdmin) {
                showNotification('Доступ запрещен!');
                return;
            }

            const playerId = document.getElementById('verifyPlayerId').value;
            const questType = document.getElementById('verifyQuestType').value;

            if (!playerId) {
                showNotification('Введите ID игрока!');
                return;
            }

            // Загружаем данные игрока
            const savedPlayerData = localStorage.getItem('playerData_' + playerId);
            if (!savedPlayerData) {
                showNotification('Игрок не найден!');
                return;
            }

            const player = JSON.parse(savedPlayerData);

            if (questType === 'subscribe') {
                player.quests.subscribe.completed = true;
                showNotification(`✅ Подписка подтверждена для игрока ${playerId}`);
            } else if (questType === 'invite') {
                player.quests.invite.progress += 1;
                showNotification(`✅ Приглашение подтверждено для игрока ${playerId}. Теперь: ${player.quests.invite.progress}/5`);
            }

            // Сохраняем обновленные данные игрока
            localStorage.setItem('playerData_' + playerId, JSON.stringify(player));

            // Если это текущий игрок - обновляем интерфейс
            if (playerId === playerData.id) {
                playerData = player;
                updateUI();
            }

            document.getElementById('verifyPlayerId').value = '';
        }

        // Автоматическое уменьшение показателей
        function startStatDecrease() {
            // Голод уменьшается каждые 10 минут
            setInterval(() => {
                if (playerData.isAlive) {
                    playerData.hunger = Math.max(0, playerData.hunger - 10);
                    checkDeath();
                    savePlayerData();
                    updateUI();
                }
            }, 600000); // 10 минут = 600000 мс

            // Настроение уменьшается каждые 1.5 часа
            setInterval(() => {
                if (playerData.isAlive) {
                    playerData.mood = Math.max(0, playerData.mood - 10);
                    checkDeath();
                    savePlayerData();
                    updateUI();
                }
            }, 5400000); // 1.5 часа = 5400000 мс
        }

        // Проверка смерти питомца
        function checkDeath() {
            if ((playerData.hunger <= 0 || playerData.mood <= 0) && playerData.isAlive) {
                playerData.isAlive = false;
                showNotification('💀 Ваш питомец умер от голода или плохого настроения! Купите новое яйцо.');
                savePlayerData();
                updateUI();
            }
        }

        // Обновление списка заявок в админ-панели
        function updateWithdrawRequests() {
            if (!isAdmin) return;
            
            const requestsContainer = document.getElementById('withdrawRequests');
            if (withdrawRequests.length === 0) {
                requestsContainer.innerHTML = '<div class="info-text">Нет заявок на вывод</div>';
            } else {
                let html = '';
                withdrawRequests.forEach((request, index) => {
                    html += `
                        <div class="withdraw-log">
                            <strong>ID игрока:</strong> ${request.playerId}<br>
                            <strong>Предмет:</strong> ${request.item}<br>
                            <strong>Telegram:</strong> ${request.telegram}<br>
                            <strong>Время:</strong> ${new Date(request.timestamp).toLocaleString()}<br>
                            <button class="withdraw-btn" onclick="completeWithdraw(${index})" style="margin-top: 5px;">✅ Выполнено</button>
                        </div>
                    `;
                });
                requestsContainer.innerHTML = html;
            }
        }

        // Таймер вылупления (17 часов)
        function startHatchTimer() {
            setInterval(() => {
                if (playerData.eggHatchTime && !playerData.isEggReady) {
                    const now = Date.now();
                    const timeLeft = playerData.eggHatchTime - now;
                    
                    if (timeLeft <= 0) {
                        playerData.isEggReady = true;
                        savePlayerData();
                        updateUI();
                        showNotification('🎉 Яйцо готово к вылуплению! Нажмите "Разбить яйцо"');
                    } else {
                        updateTimerDisplay(timeLeft);
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay(timeLeft) {
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            document.getElementById('timerValue').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Система выпадения предметов
        const dropSystem = {
            normal: [
                { item: '❤️ Сердечко', chance: 40 },
                { item: '🌹 Роза', chance: 25 },
                { item: '📅 Календарь', chance: 5 },
                { item: 'Ничего', chance: 30 }
            ],
            gold: [
                { item: '🍷 Вино', chance: 50 },
                { item: '📅 Календарь', chance: 25 },
                { item: '🎅 Шапка Санты', chance: 5 },
                { item: '🎁 Коробка конфет', chance: 2 },
                { item: 'Ничего', chance: 18 }
            ]
        };

        function getRandomItem(eggType) {
            const items = dropSystem[eggType];
            const random = Math.random() * 100;
            let currentChance = 0;
            for (const item of items) {
                currentChance += item.chance;
                if (random < currentChance) {
                    return item.item;
                }
            }
            return 'Ничего';
        }

        // Функции питомца
        function feedPet() {
            if (!playerData.isAlive) {
                showNotification('Яйцо умерло! Купите новое в магазине');
                return;
            }
            if (playerData.foodCount <= 0) {
                showNotification('Закончилась еда! Купите в магазине');
                return;
            }
            
            playerData.foodCount--;
            playerData.hunger = Math.min(100, playerData.hunger + 25);
            
            // Если это первое кормление сегодня - запускаем таймер на 17 часов
            if (!playerData.hasFedToday) {
                playerData.hasFedToday = true;
                playerData.eggHatchTime = Date.now() + (17 * 60 * 60 * 1000); // 17 часов
                playerData.isEggReady = false;
                showNotification('🍎 Питомец покормлен! Яйцо начало вылупляться... Через 17 часов будет готово!');
            } else {
                showNotification('🍎 Питомец покормлен!');
            }
            
            savePlayerData();
            updateUI();
        }

        function playWithPet() {
            if (!playerData.isAlive) {
                showNotification('Яйцо умерло! Купите новое в магазине');
                return;
            }
            if (playerData.mood >= 100) {
                showNotification('Настроение питомца уже максимальное!');
                return;
            }
            playerData.mood = Math.min(100, playerData.mood + 15);
            playerData.hunger = Math.max(0, playerData.hunger - 10);
            savePlayerData();
            updateUI();
            showNotification('Вы поиграли с питомцем! 🎮');
        }

        function hatchEgg() {
            if (!playerData.isEggReady) {
                showNotification('Яйцо еще не готово!');
                return;
            }

            // Подарок выпадает ТОЛЬКО при вылуплении
            const gift = getRandomItem(playerData.eggType);
            
            if (gift !== 'Ничего') {
                playerData.items.push({
                    name: gift,
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    timestamp: Date.now()
                });
                showNotification(`🎉 Поздравляем! Вам выпало: ${gift}`);
            } else {
                showNotification('К сожалению, в яйце ничего не оказалось 😢');
            }

            // Сбрасываем состояние яйца
            playerData.eggHatchTime = null;
            playerData.isEggReady = false;
            playerData.hasFedToday = false;
            savePlayerData();
            updateUI();
        }

        // Обновление интерфейса
        function updateUI() {
            document.getElementById('hungerValue').textContent = playerData.hunger + '/100';
            document.getElementById('moodValue').textContent = playerData.mood + '/100';
            document.getElementById('starsValue').textContent = playerData.stars;
            document.getElementById('itemsValue').textContent = playerData.items.length;
            document.getElementById('foodCount').textContent = 'Еды: ' + playerData.foodCount;
            
            const eggDisplay = document.getElementById('eggDisplay');
            const eggTypeDisplay = document.getElementById('eggTypeDisplay');
            const timer = document.getElementById('eggTimer');
            const hatchBtn = document.getElementById('hatchBtn');
            const deathMessage = document.getElementById('deathMessage');
            const feedBtn = document.getElementById('feedBtn');
            const playBtn = document.getElementById('playBtn');

            if (!playerData.isAlive) {
                eggDisplay.textContent = '💀';
                eggDisplay.classList.add('dead-egg');
                eggTypeDisplay.style.display = 'none';
                timer.style.display = 'none';
                hatchBtn.style.display = 'none';
                deathMessage.style.display = 'block';
                feedBtn.disabled = true;
                playBtn.disabled = true;
            } else {
                eggDisplay.textContent = playerData.eggType === 'gold' ? '🥚' : '🐣';
                eggDisplay.classList.remove('dead-egg');
                eggTypeDisplay.textContent = playerData.eggType === 'gold' ? 'Золотое яйцо' : 'Обычное яйцо';
                eggTypeDisplay.style.display = 'inline-block';
                deathMessage.style.display = 'none';
                
                // Кнопка кормления отключается при сытости 100
                feedBtn.disabled = playerData.foodCount <= 0 || playerData.hunger >= 100;
                
                // Кнопка игры отключается при настроении 100
                playBtn.disabled = playerData.mood >= 100;

                if (playerData.eggHatchTime && !playerData.isEggReady) {
                    timer.style.display = 'block';
                    hatchBtn.style.display = 'none';
                } else if (playerData.isEggReady) {
                    timer.style.display = 'none';
                    hatchBtn.style.display = 'block';
                } else {
                    timer.style.display = 'none';
                    hatchBtn.style.display = 'none';
                }
            }
        }

        // Магазин
        let currentItemToBuy = null;

        function openShop() {
            document.getElementById('shopModal').classList.add('active');
        }

        function closeShop() {
            document.getElementById('shopModal').classList.remove('active');
        }

        function buyItem(itemType, cost) {
            currentItemToBuy = { type: itemType, cost: cost };
            
            let itemName = '';
            switch(itemType) {
                case 'gold_egg': itemName = 'Золотое яйцо'; break;
                case 'food': itemName = 'Еда (3 шт)'; break;
                case 'normal_egg': itemName = 'Обычное яйцо'; break;
            }
            
            document.getElementById('confirmText').textContent = `Вы уверены, что хотите купить ${itemName} за ${cost} звёзд?`;
            document.getElementById('confirmModal').classList.add('active');
        }

        function confirmPurchase() {
            if (!currentItemToBuy) return;

            if (playerData.stars < currentItemToBuy.cost) {
                showNotification('Недостаточно звёзд!');
                closeConfirm();
                return;
            }

            playerData.stars -= currentItemToBuy.cost;

            switch(currentItemToBuy.type) {
                case 'gold_egg':
                    playerData.eggType = 'gold';
                    showNotification('Теперь у вас золотое яйцо!');
                    break;
                case 'food':
                    playerData.foodCount += 3;
                    showNotification('Запас еды пополнен!');
                    break;
                case 'normal_egg':
                    playerData.isAlive = true;
                    playerData.hunger = 50;
                    playerData.mood = 50;
                    playerData.eggType = 'normal';
                    showNotification('Новое яйцо куплено!');
                    break;
            }

            savePlayerData();
            updateUI();
            closeConfirm();
            closeShop();
        }

        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('active');
            currentItemToBuy = null;
        }

        // Инвентарь и вывод
        let currentWithdrawItem = null;

        function openInventory() {
            const inventoryItems = document.getElementById('inventoryItems');
            
            if (playerData.items.length === 0) {
                inventoryItems.innerHTML = `
                    <div class="empty-inventory">
                        <h3>📦 Инвентарь пуст</h3>
                        <p>Вылупите яйцо, чтобы получить предметы!</p>
                    </div>
                `;
            } else {
                let itemsHTML = '';
                playerData.items.forEach((item, index) => {
                    itemsHTML += `
                        <div class="inventory-item">
                            <span>${item.name}</span>
                            <button class="withdraw-btn" onclick="startWithdraw(${index})">Вывод</button>
                        </div>
                    `;
                });
                inventoryItems.innerHTML = itemsHTML;
            }
            
            document.getElementById('inventoryModal').classList.add('active');
        }

        function closeInventory() {
            document.getElementById('inventoryModal').classList.remove('active');
        }

        function startWithdraw(itemIndex) {
            currentWithdrawItem = itemIndex;
            const item = playerData.items[itemIndex];
            document.getElementById('withdrawItemName').textContent = item.name;
            document.getElementById('telegramUsername').value = '';
            document.getElementById('withdrawModal').classList.add('active');
        }

        function closeWithdraw() {
            document.getElementById('withdrawModal').classList.remove('active');
            currentWithdrawItem = null;
        }

        function submitWithdraw() {
            const telegram = document.getElementById('telegramUsername').value;
            if (!telegram) {
                showNotification('Введите Telegram username!');
                return;
            }

            const item = playerData.items[currentWithdrawItem];
            
            // Создаем заявку на вывод
            const withdrawRequest = {
                playerId: playerData.id,
                item: item.name,
                telegram: telegram,
                timestamp: Date.now(),
                itemId: item.id,
                status: 'pending'
            };
            
            withdrawRequests.push(withdrawRequest);
            
            // Удаляем предмет из инвентаря
            playerData.items.splice(currentWithdrawItem, 1);
            
            savePlayerData();
            updateUI();
            closeWithdraw();
            closeInventory();
            
            showNotification('✅ Заявка на вывод отправлена! С вами свяжутся в Telegram.');
            updateWithdrawRequests();
        }

        // Админ: выполнить вывод
        function completeWithdraw(requestIndex) {
            if (!isAdmin) {
                showNotification('Доступ запрещен!');
                return;
            }

            const request = withdrawRequests[requestIndex];
            if (confirm(`Отметить заявку от ${request.playerId} как выполненную?\nПредмет: ${request.item}\nTelegram: ${request.telegram}`)) {
                withdrawRequests.splice(requestIndex, 1);
                savePlayerData();
                updateWithdrawRequests();
                showNotification('✅ Заявка отмечена как выполненная!');
            }
        }

        // Уведомления
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Админ-панель
        document.getElementById('adminToggle').onclick = function() {
            if (!isAdmin) return;
            
            const adminPanel = document.getElementById('adminPanel');
            adminPanel.classList.toggle('active');
            this.textContent = adminPanel.classList.contains('active') ? '🔧 Скрыть Админ Панель' : '🔧 Админ Панель';
        };

        document.getElementById('adminApply').onclick = function() {
            if (!isAdmin) {
                showNotification('Доступ запрещен!');
                return;
            }

            const playerIdInput = document.getElementById('adminPlayerId').value;
            const starsInput = document.getElementById('adminStars').value;

            if (!playerIdInput || !starsInput) {
                showNotification('Заполните ID игрока и количество звёзд!');
                return;
            }

            // В реальном приложении здесь был бы запрос к серверу
            showNotification(`✅ Выдано ${starsInput} звёзд игроку ${playerIdInput}`);
            
            document.getElementById('adminPlayerId').value = '';
            document.getElementById('adminStars').value = '';
        };

        document.getElementById('adminReset').onclick = function() {
            if (!isAdmin) {
                showNotification('Доступ запрещен!');
                return;
            }

            const playerIdInput = document.getElementById('adminPlayerId').value;
            
            if (!playerIdInput) {
                showNotification('Введите ID игрока для сброса!');
                return;
            }

            if(confirm(`Сбросить прогресс игрока ${playerIdInput}?`)) {
                // В реальном приложении здесь был бы запрос к серверу
                showNotification(`✅ Прогресс игрока ${playerIdInput} сброшен!`);
                document.getElementById('adminPlayerId').value = '';
            }
        };

        // Обработчики событий
        document.getElementById('feedBtn').onclick = feedPet;
        document.getElementById('playBtn').onclick = playWithPet;
        document.getElementById('hatchBtn').onclick = hatchEgg;
        document.getElementById('shopBtn').onclick = openShop;
        document.getElementById('inventoryBtn').onclick = openInventory;
        document.getElementById('questsBtn').onclick = openQuests;
        document.getElementById('closeShop').onclick = closeShop;
        document.getElementById('verifyQuest').onclick = verifyQuestCompletion;

        // Закрытие модальных окон при клике вне их
        document.getElementById('shopModal').onclick = function(e) {
            if (e.target === this) closeShop();
        };
        document.getElementById('confirmModal').onclick = function(e) {
            if (e.target === this) closeConfirm();
        };
        document.getElementById('inventoryModal').onclick = function(e) {
            if (e.target === this) closeInventory();
        };
        document.getElementById('withdrawModal').onclick = function(e) {
            if (e.target === this) closeWithdraw();
        };
        document.getElementById('questsModal').onclick = function(e) {
            if (e.target === this) closeQuests();
        };

        // Запуск игры
        initGame();
    </script>
</body>
</html>
